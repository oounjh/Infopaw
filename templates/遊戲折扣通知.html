{% extends "base.html" %}

{% block title %}éŠæˆ²æŠ˜æ‰£é€šçŸ¥ - InfoPaw{% endblock %}

{% block head_extra %}
<meta name="keywords" content="é™å…éŠæˆ², Steam ç‰¹åƒ¹, Epic å…è²», GOG å„ªæƒ , éŠæˆ²è¿½è¹¤">
<meta property="og:title" content="é™å…èˆ‡ç‰¹åƒ¹éŠæˆ²æ›´æ–° - InfoPaw">
<meta property="og:description" content="æŒæ¡å„å¤§å¹³å°éŠæˆ²é™æ™‚å„ªæƒ è³‡è¨Šï¼ŒçœéŒ¢ä¸éŒ¯éï¼">
<meta property="og:url" content="https://infopaw.onrender.com/freegames">

<style>
  img {
    max-width: 100%;
    height: auto;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    image-rendering: -moz-crisp-edges;
    image-rendering: pixelated;
  }

  /* èƒŒæ™¯å›ºå®š */
  body {
    min-height: 100vh;
    background-image: url('/static/game.png');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    background-attachment: fixed;
  }

  /* å‰ç¥¥ç‰©å‹•ç•«èˆ‡è¨Šæ¯æ¡† */
  @keyframes sway {
    0% { transform: rotate(0deg); }
    50% { transform: rotate(10deg); }
    100% { transform: rotate(0deg); }
  }

  #mascot1 {
    animation: sway 5s infinite;
    transform-origin: bottom center;
    position: fixed;
    bottom: 10px;
    right: 10px;
    cursor: pointer;
    z-index: 1000;
    max-width: 120px; 
    max-height: 120px; 
    transition: all 1s ease;
  }

  .message1-box {
    position: fixed;
    bottom: 140px;
    right: 10px;
    background-color: rgba(255, 255, 255, 0.95);
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    font-weight: bold;
    font-size: 16px;
    color: #333;
    opacity: 0;
    pointer-events: none;
    transition: opacity 1s ease;
    z-index: 999;
    max-width: 250px;
  }

  .message1-box.show {
    opacity: 1;
    pointer-events: auto;
  }

  form {
    margin-top: 20px;
    color: white;
  }

  form label, form select, form input, form button {
    margin-right: 10px;
    font-weight: bold;
  }

  form select, form input {
    padding: 5px;
    border-radius: 4px;
    border: none;
  }

  form button {
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    background-color: #4CAF50;
    color: white;
  }

  #game-list ul {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    list-style: none;
    padding-left: 0;
  }

  #game-list li {
    border: 1px solid #ccc;
    color: white;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 16px;
    width: 400px;
  }

  #game-list li h3 {
    margin-top: 0;
  }

  #game-list li img {
    max-width: 100%;
    height: auto;
    margin-bottom: 8px;
  }

  #game-list li a {
    color: #808080;
    text-decoration: none;
    font-weight: bold;
  }

  #top-buttons {
    position: fixed;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    z-index: 1001;
  }

  #top-buttons a, #top-buttons form button {
    padding: 8px 16px;
    background-color: #f2f2f2;
    color: #333;
    text-decoration: none;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-weight: bold;
  }

  #top-buttons form {
    margin: 0;
  }
</style>
{% endblock %}

{% block content %}

<h1 style="color: white;">ğŸ® éŠæˆ²æŠ˜æ‰£é€šçŸ¥</h1>

<!-- å‰ç¥¥ç‰© -->
<img src="{{ url_for('static', filename='mascot1.png') }}" alt="å‰ç¥¥ç‰©" id="mascot1">

<!-- å‰ç¥¥ç‰©è¨Šæ¯æ¡† -->
<div id="mascot1-message" class="message1-box"></div>

<!-- å¹³å°åŠæŠ˜æ‰£é¸æ“‡è¡¨å–® -->
<form method="get">
  <label for="platform">é¸æ“‡å¹³å°:</label>
  <select name="platform" id="platform" onchange="handlePlatformChange(true)">
    <option value="" disabled selected>è«‹é¸æ“‡å¹³å°</option>
    <option value="steam">Steam</option>
    <option value="epic">Epic Games</option>
    <option value="gog">GOG</option>
  </select>

  <label for="discount_range">æŠ˜æ‰£å€é–“:</label>
  <select name="discount_range" id="discount_range" onchange="this.form.submit()">
    <option value="">å…¨éƒ¨</option>
    <option value="100">ğŸ 100% å…è²»</option>
    <option value="80-99">ğŸ’° 80%~99%</option>
    <option value="60-79">ğŸ’° 60%~79%</option>
    <option value="40-59">ğŸ’° 40%~59%</option>
    <option value="20-39">ğŸ’° 20%~39%</option>
    <option value="1-19">ğŸ’° 1%~19%</option>
  </select>

  <label for="search">æœå°‹éŠæˆ²åç¨±:</label>
  <input type="text" id="search" name="search" />
  <button type="submit">æœå°‹</button>
</form>

<!-- éŠæˆ²åˆ—è¡¨ -->
<div id="game-list"></div>

<!-- è¿”å›èˆ‡åˆ·æ–°æŒ‰éˆ• -->
<div id="top-buttons">
  <a href="/">â¬… è¿”å›ä¸»ç¶²ç«™</a>
  <form method="get" action="/freegames/" >
    <button type="submit">ğŸ”„åˆ·æ–°é é¢ğŸ”„</button>
  </form>
</div>

<!-- å‰ç¥¥ç‰©äº’å‹•è…³æœ¬ -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const mascot = document.getElementById('mascot1');
  const messageBox = document.getElementById('mascot1-message');
  let hideTimeout;

  const messages = [
    'é€™å€‹ç¶²ç«™æœƒé¡¯ç¤ºéŠæˆ²çš„æŠ˜æ‰£èˆ‡é™å…!',
    'é»æ“ŠğŸ”„æŒ‰éˆ•å¯ä»¥åˆ·æ–°å…¨éƒ¨æ¢ä»¶ï¼',
    'å®Œæ•´è³‡è¨Šæ¨è–¦å»æœ‰èˆˆè¶£çš„å¹³å°æŸ¥çœ‹!',
    'æœ‰èˆˆè¶£çš„éŠæˆ²å¯ä»¥é»æ“Šå‰å¾€è³¼è²·ã€‚',
    'ç›®å‰Epicåªæ”¯æ´é™å…è³‡è¨Šã€‚'
  ];

  if (!sessionStorage.getItem('mascotWelcomeShown')) {
    showMessage('æ­¡è¿ä¾†åˆ°éŠæˆ²æŠ˜æ‰£å±•ç¤ºç¶²ç«™ï¼é»æ“Šæˆ‘å¯ä»¥çœ‹æ›´å¤šè³‡è¨Šå–”ï¼');
    sessionStorage.setItem('mascotWelcomeShown', 'true');
  }

  mascot.addEventListener('click', function () {
    const index = Math.floor(Math.random() * messages.length);
    showMessage(messages[index]);
  });

  function showMessage(text) {
    messageBox.textContent = text;
    messageBox.classList.add('show');

    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      messageBox.classList.remove('show');
      setTimeout(() => {
        if (!messageBox.classList.contains('show')) {
          messageBox.textContent = '';
        }
      }, 1000);
    }, 4000);
  }
});
</script>

<!-- å¹³å°é¸æ“‡æ§åˆ¶ -->
<script>
function handlePlatformChange(submitFrom = true) {
  const platformSelect = document.getElementById('platform');
  const discountSelect = document.getElementById("discount_range");
  const discountLabel = document.querySelector('label[for="discount_range"]');

  if (platformSelect.value === 'epic') {
    discountSelect.value = '';
    discountSelect.disabled = true;
    discountSelect.removeAttribute('name');
    discountSelect.style.display = 'none';
    discountLabel.style.display = 'none';
  } else {
    discountSelect.disabled = false;
    discountSelect.setAttribute('name', 'discount_range');
    discountSelect.style.display = '';
    discountLabel.style.display = '';
  }
  if (submitFrom) {
    platformSelect.form.submit();
  }
}

window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const platform = urlParams.get('platform');
  const discountRange = urlParams.get('discount_range');
  const search = urlParams.get('search');

  if (platform) {
    document.getElementById('platform').value = platform;
    if (discountRange) {
      document.getElementById('discount_range').value = discountRange;
    }
    if (search) {
      document.getElementById('search').value = search;
    }
  }

  handlePlatformChange(false);

  if (!platform) {
    document.getElementById('game-list').innerHTML = '<p style="color:white;">è«‹å…ˆé¸æ“‡å¹³å°ã€‚</p>';
    return;
  }

  fetch(`/api/get_cache?platform=${platform}`)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById('game-list').innerHTML = '<p style="color:white;">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„éŠæˆ²ã€‚</p>';
        return;
      }


      const now = new Date();
      if (platform === 'epic') {
        data = data.filter(game => {
          if (!game.startDate || !game.endDate) return true;
          const start = new Date(game.startDate);
          const end = new Date(game.endDate);
          if (game.type === 'free') {
            return now >= start && now <= end;
          } else if (game.type === 'upcoming') {
            return now < start;
          }
          return false;
        });
      }


      let filteredGames = data;

      if (discountRange) {
        if (discountRange === '100') {
          filteredGames = filteredGames.filter(game => game.discount_pct_value === 100);
        } else if (discountRange.includes('-')) {
          const [min, max] = discountRange.split('-').map(Number);
          filteredGames = filteredGames.filter(game => game.discount_pct_value >= min && game.discount_pct_value <= max);
        }
      }

      if (search) {
        filteredGames = filteredGames.filter(game => game.title.toLowerCase().includes(search.toLowerCase()));
      }

      if (filteredGames.length === 0) {
        document.getElementById('game-list').innerHTML = '<p style="color:white;">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„éŠæˆ²ã€‚</p>';
        return;
      }

      const listHTML = filteredGames.map(game => `
        <li>
          <h3>${game.title}</h3>
          <img src="${game.image_big}" onerror="this.onerror=null; this.src='${game.image_small}';" alt="game image">
          <p>å¹³å°: ${game.platform}</p>
          <div>
            <p><strong>åŸåƒ¹:</strong> ${game.original_price || 'æœªçŸ¥'}</p>
            <p><strong>æŠ˜æ‰£:</strong> ${game.discount || 'ç„¡æŠ˜æ‰£'}</p>
            <p><strong>ç¾åƒ¹:</strong> ${game.final_price || 'å…è²»'}</p>
          </div>
          <a href="${game.link}" target="_blank" style="color: #808080;">å‰å¾€è³¼è²·</a>
        </li>
      `).join('');

      document.getElementById('game-list').innerHTML = `<ul>${listHTML}</ul>`;
    })
    .catch(err => {
      console.error('API éŒ¯èª¤:', err);
      document.getElementById('game-list').innerHTML = '<p style="color:white;">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
    });
});
</script>

{% endblock %}
